# Page snapshot

```yaml
- generic [active] [ref=e1]:
  - banner [ref=e2]:
    - generic [ref=e3]:
      - link "10x Cards" [ref=e4] [cursor=pointer]:
        - /url: /
      - navigation [ref=e5]:
        - list [ref=e6]:
          - listitem [ref=e7]:
            - button "Zaloguj się" [ref=e8]
          - listitem [ref=e9]:
            - button "Zarejestruj się" [ref=e10]
  - main [ref=e11]:
    - generic [ref=e12]:
      - generic [ref=e14]:
        - generic [ref=e15]:
          - generic [ref=e16]: Logowanie
          - generic [ref=e17]: Wprowadź swój email i hasło, aby się zalogować.
        - generic [ref=e18]:
          - generic [ref=e19]:
            - generic [ref=e20]:
              - generic [ref=e21]: Email
              - textbox "Email" [ref=e22]:
                - /placeholder: m@example.com
            - generic [ref=e23]:
              - generic [ref=e24]: Hasło
              - textbox "Hasło" [ref=e25]
          - generic [ref=e26]:
            - button "Zaloguj się" [ref=e27]
            - link "Zapomniałeś hasła?" [ref=e29] [cursor=pointer]:
              - /url: /auth/forgot-password
      - generic [ref=e30]:
        - text: Nie masz konta?
        - link "Zarejestruj się" [ref=e31] [cursor=pointer]:
          - /url: /auth/register
  - generic [ref=e34]:
    - generic [ref=e35]:
      - checkbox "Use dark theme" [ref=e36]
      - generic [ref=e37] [cursor=pointer]:
        - img [ref=e38]
        - img [ref=e42]
        - generic [ref=e46]: Use dark theme
    - banner [ref=e47]:
      - generic [ref=e48]:
        - heading "ReferenceError" [level=2] [ref=e49]
        - heading "An error occurred." [level=1] [ref=e50]
      - img [ref=e53]
    - generic [ref=e57]:
      - img [ref=e59]
      - generic [ref=e61]: Cannot access 'session' before initialization
    - generic [ref=e62]:
      - generic [ref=e63]:
        - heading "middleware/index.ts:65:22" [level=2] [ref=e64]
        - button "Open in editor" [ref=e66]:
          - text: Open in editor
          - img [ref=e67]
      - code [ref=e72]:
        - generic [ref=e73]: /* eslint-disable @typescript-eslint/no-explicit-any */
        - generic [ref=e74]: "import { defineMiddleware } from \"astro:middleware\";"
        - generic [ref=e75]: "import { createSupabaseServerInstance } from \"@/db/supabase.client\";"
        - generic [ref=e77]: "export const onRequest = defineMiddleware(async (context, next) => {"
        - generic [ref=e78]: "const { url, cookies, request, redirect } = context;"
        - generic [ref=e80]: // Skip authentication in test environment
        - generic [ref=e81]: const userAgent = request.headers.get("user-agent") || "";
        - generic [ref=e82]: const hasE2eParam = url.searchParams.has("e2e");
        - generic [ref=e83]: const hasTestParam = url.searchParams.has("test");
        - generic [ref=e84]: const hasPlaywrightUA = userAgent.includes("Playwright") || userAgent.includes("playwright");
        - generic [ref=e86]: const isTestMode = process.env.NODE_ENV === "test" || hasTestParam || hasE2eParam || hasPlaywrightUA;
        - generic [ref=e88]: // Debug log to see what's happening
        - generic [ref=e89]: "if (hasE2eParam || hasTestParam || hasPlaywrightUA) {"
        - generic [ref=e90]: "console.log(\"Test detection:\", {"
        - generic [ref=e91]: "url: url.pathname + url.search,"
        - generic [ref=e92]: hasE2eParam,
        - generic [ref=e93]: hasTestParam,
        - generic [ref=e94]: hasPlaywrightUA,
        - generic [ref=e95]: isTestMode,
        - generic [ref=e96]: "userAgent: userAgent.substring(0, 100),"
        - generic [ref=e97]: "});"
        - generic [ref=e98]: "}"
        - generic [ref=e100]: "if (isTestMode) {"
        - generic [ref=e101]: // Create a mock session for tests
        - generic [ref=e102]: "context.locals.session = {"
        - generic [ref=e103]: "user: {"
        - generic [ref=e104]: "id: \"test-user-id\","
        - generic [ref=e105]: "email: \"test@example.com\","
        - generic [ref=e106]: "},"
        - generic [ref=e107]: "access_token: \"test-token\","
        - generic [ref=e108]: "refresh_token: \"test-refresh-token\","
        - generic [ref=e109]: "expires_in: 3600,"
        - generic [ref=e110]: "expires_at: Date.now() + 3600000,"
        - generic [ref=e111]: "token_type: \"bearer\","
        - generic [ref=e112]: "} as any;"
        - generic [ref=e114]: return next();
        - generic [ref=e115]: "}"
        - generic [ref=e117]: // Lista ścieżek, które nie wymagają uwierzytelnienia
        - generic [ref=e118]: const publicPaths = [
        - generic [ref=e119]: "\"/\","
        - generic [ref=e120]: "\"/auth/login\","
        - generic [ref=e121]: "\"/auth/register\","
        - generic [ref=e122]: "\"/auth/forgot-password\","
        - generic [ref=e123]: "\"/auth/reset-password\","
        - generic [ref=e124]: "\"/api/auth/login\","
        - generic [ref=e125]: "\"/api/auth/register\","
        - generic [ref=e126]: "\"/api/auth/forgot-password\","
        - generic [ref=e127]: "\"/api/auth/update-password\","
        - generic [ref=e128]: "];"
        - generic [ref=e130]: const isPublicPath = publicPaths.some((path) => url.pathname === path);
        - generic [ref=e132]: // Extra debug for homepage
        - generic [ref=e133]: "if (url.pathname === \"/\") {"
        - generic [ref=e134]: "console.log(\"Homepage request:\", {"
        - generic [ref=e135]: isTestMode,
        - generic [ref=e136]: isPublicPath,
        - generic [ref=e137]: "willRedirect: !session && !isPublicPath && !isTestMode"
        - generic [ref=e138]: ^
        - generic [ref=e139]: "});"
        - generic [ref=e140]: "}"
        - generic [ref=e142]: "const supabase = createSupabaseServerInstance({ cookies, headers: request.headers });"
        - generic [ref=e144]: "const {"
        - generic [ref=e145]: "data: { session },"
        - generic [ref=e146]: "} = await supabase.auth.getSession();"
        - generic [ref=e147]: context.locals.session = session;
        - generic [ref=e149]: // Handle homepage in test mode - redirect to generate page
        - generic [ref=e150]: "if (isTestMode && url.pathname === \"/\") {"
        - generic [ref=e151]: return redirect("/generate");
        - generic [ref=e152]: "}"
        - generic [ref=e154]: "if (!session && !isPublicPath) {"
        - generic [ref=e155]: return redirect("/auth/login");
        - generic [ref=e156]: "}"
        - generic [ref=e158]: "if (session && (url.pathname === \"/auth/login\" || url.pathname === \"/auth/register\")) {"
        - generic [ref=e159]: return redirect("/generate");
        - generic [ref=e160]: "}"
        - generic [ref=e162]: return next();
        - generic [ref=e163]: "});"
    - generic [ref=e165]:
      - generic [ref=e166]:
        - heading "Stack Trace" [level=2] [ref=e167]
        - img [ref=e169] [cursor=pointer]
      - generic [ref=e173]: "ReferenceError: Cannot access 'session' before initialization at c:\\Users\\agata\\Documents\\10xdev-project\\src\\middleware\\index.ts:65:22 at applyHandle (c:\\Users\\agata\\Documents\\10xdev-project\\node_modules\\astro\\dist\\core\\middleware\\sequence.js:20:22) at c:\\Users\\agata\\Documents\\10xdev-project\\node_modules\\astro\\dist\\core\\middleware\\sequence.js:17:12 at applyHandle (file:///c:/Users/agata/Documents/10xdev-project/node_modules/astro/dist/core/middleware/sequence.js:20:22) at file:///c:/Users/agata/Documents/10xdev-project/node_modules/astro/dist/core/middleware/sequence.js:63:18 at payload (file:///c:/Users/agata/Documents/10xdev-project/node_modules/astro/dist/i18n/middleware.js:11:34) at applyHandle (file:///c:/Users/agata/Documents/10xdev-project/node_modules/astro/dist/core/middleware/sequence.js:20:22) at file:///c:/Users/agata/Documents/10xdev-project/node_modules/astro/dist/core/middleware/sequence.js:17:12 at callMiddleware (file:///c:/Users/agata/Documents/10xdev-project/node_modules/astro/dist/core/middleware/callMiddleware.js:10:27) at RenderContext.render (file:///c:/Users/agata/Documents/10xdev-project/node_modules/astro/dist/core/render-context.js:249:28)"
  - generic [ref=e176]:
    - button "Menu" [ref=e177]:
      - img [ref=e179]
      - generic: Menu
    - button "Inspect" [ref=e183]:
      - img [ref=e185]
      - generic: Inspect
    - button "Audit" [ref=e187]:
      - img [ref=e189]
      - generic: Audit
    - button "Settings" [ref=e192]:
      - img [ref=e194]
      - generic: Settings
```